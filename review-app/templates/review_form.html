<!DOCTYPE html>
<html>
<head>
    <title>Submit a Review</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 500px; margin: auto; padding: 20px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); border-radius: 5px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; }
        select, input, textarea { width: 100%; padding: 8px; margin-top: 5px; }
        button { background-color: #007bff; color: white; padding: 10px; border: none; cursor: pointer; width: 100%; }
        button:hover { background-color: #0056b3; }
        .review-entry { border-bottom: 1px solid #ddd; padding: 10px 0; margin-top: 15px; }
        .stars { color: gold; font-size: 18px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Submit a Review</h2>
    <form id="review-form">
        <div class="form-group">
            <label for="user_name">Your Name:</label>
            <input type="text" id="user_name" required>
        </div>
        <div class="form-group">
            <label for="email">Your Email:</label>
            <input type="email" id="email" required>
        </div>
        <div class="form-group">
            <label for="company">Company:</label>
            <select id="company" required></select>
        </div>
        <div class="form-group">
            <label for="product">Product:</label>
            <select id="product" required></select>
        </div>
        <div class="form-group">
            <label for="review">Review:</label>
            <textarea id="review" required></textarea>
        </div>
        <div class="form-group">
            <label for="rating">Rating (1-5):</label>
            <input type="number" id="rating" min="1" max="5" required>
        </div>
        <button type="submit">Submit Review</button>
    </form>
</div>

<h2>Recent Reviews</h2>
<div id="review-list"></div>

<script>
    async function loadCompanies() {
        const response = await fetch('/get-companies');
        const companies = await response.json();
        const companyDropdown = document.getElementById('company');
        companyDropdown.innerHTML = "<option value=''>Select a Company</option>";
        companies.forEach(company => {
            companyDropdown.innerHTML += `<option value="${company.id}">${company.name}</option>`;
        });
    }

    async function loadProducts(companyId) {
        if (!companyId) return;
        const response = await fetch(`/get-products?company_id=${companyId}`);
        const products = await response.json();
        const productDropdown = document.getElementById('product');
        productDropdown.innerHTML = "<option value=''>Select a Product</option>";
        products.forEach(product => {
            productDropdown.innerHTML += `<option value="${product.id}">${product.name}</option>`;
        });
    }

    document.getElementById('company').addEventListener('change', function() {
        loadProducts(this.value);
    });

    document.getElementById('review-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = {
            user_name: document.getElementById('user_name').value,
            email: document.getElementById('email').value,
            company_id: document.getElementById('company').value,
            product_id: document.getElementById('product').value,
            review: document.getElementById('review').value,
            rating: document.getElementById('rating').value
        };
        
        const response = await fetch('/submit-review', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        displayReview(formData.user_name, formData.review, formData.rating, data.ai_response);
    });

    function displayReview(name, review, rating, aiResponse) {
        const reviewList = document.getElementById('review-list');
        const reviewEntry = document.createElement('div');
        reviewEntry.classList.add('review-entry');
        reviewEntry.innerHTML = `
            <strong>${name}</strong>: ${review}
            <div class="stars">${'★'.repeat(rating)}${'☆'.repeat(5 - rating)}</div>
            <p><strong>AI Reply:</strong> ${aiResponse}</p>
        `;
        reviewList.prepend(reviewEntry);
    }

    loadCompanies();
</script>

</body>
</html>
